"use strict";(()=>{(self.webpackChunk_automattic_jetpack_storybook=self.webpackChunk_automattic_jetpack_storybook||[]).push([[7800],{"../../packages/videopress/src/client/state/constants.js":(ao,oe,k)=>{k.d(oe,{$A:()=>Ie,$L:()=>n,CM:()=>Ae,Db:()=>Ne,Dj:()=>Se,El:()=>we,Et:()=>x,FP:()=>$,FY:()=>se,Gr:()=>Be,H:()=>ce,IN:()=>Le,JV:()=>G,Kc:()=>v,NL:()=>_e,O1:()=>Pe,Og:()=>Ee,Ps:()=>fe,QC:()=>de,RB:()=>ge,TD:()=>Ue,UJ:()=>Ve,Vc:()=>pe,Vm:()=>Ce,Vz:()=>je,WJ:()=>xe,W_:()=>B,Wi:()=>ae,Z5:()=>We,ZP:()=>N,Zp:()=>H,ah:()=>Ye,b1:()=>be,dY:()=>ke,fi:()=>Oe,jV:()=>He,jc:()=>Qe,kH:()=>Ge,o1:()=>Fe,p0:()=>ye,pD:()=>ue,pI:()=>De,pf:()=>$e,qP:()=>re,tH:()=>M,tT:()=>te,tb:()=>ie,tw:()=>me,u_:()=>R,uo:()=>L,vP:()=>F,wI:()=>he,x4:()=>Me,x_:()=>ve,z$:()=>le,z8:()=>Re});const te="videopress/media",ne="/wp-admin/admin-ajax.php",v="wp/v2/users",R="wp/v2/media",se="wpcom/v2/videopress",ie="wpcom/v2/videopress/meta",re="wpcom/v2/videopress/playback-jwt",L="videopress/v1/settings",G="videopress/v1/site",de="SET_IS_FETCHING_VIDEOS",M="SET_VIDEOS_FETCH_ERROR",Se="SET_VIDEOS_QUERY",ce="SET_VIDEOS_PAGINATION",ye="SET_VIDEOS",F="SET_VIDEOS_STORAGE_USED",ae="SET_UPLOADED_VIDEO_COUNT",le="SET_IS_FETCHING_UPLOADED_VIDEO_COUNT",ue="DISMISS_FIRST_VIDEO_POPOVER",$="SET_LOCAL_VIDEOS",N="SET_IS_FETCHING_LOCAL_VIDEOS",fe="SET_LOCAL_VIDEOS_QUERY",pe="SET_LOCAL_VIDEOS_PAGINATION",B="SET_LOCAL_VIDEO_UPLOADED",n="SET_VIDEOS_FILTER",x="SET_VIDEO",_e="SET_VIDEO_PRIVACY",ge="UPDATE_VIDEO_PRIVACY",me="DELETE_VIDEO",Ee="REMOVE_VIDEO",H="FLUSH_DELETED_VIDEOS",he="UPDATE_PAGINATION_AFTER_DELETE",ve="SET_VIDEO_UPLOADING",Oe="SET_VIDEO_PROCESSING",De="SET_VIDEO_UPLOADED",ke="SET_VIDEO_UPLOAD_PROGRESS",Ae="SET_IS_FETCHING_PURCHASES",Re="SET_PURCHASES",Ue="SET_IS_FETCHING_PLAYBACK_TOKEN",we="SET_PLAYBACK_TOKEN",Fe="EXPIRE_PLAYBACK_TOKEN",be="SET_USERS",Le="SET_USERS_PAGINATION",Ne="SET_UPDATING_VIDEO_POSTER",Ce="UPDATE_VIDEO_POSTER",xe="SET_VIDEOPRESS_SETTINGS",He="UPDATE_VIDEO_IS_PRIVATE",lo=null,Ie="public",Ve="private",Pe="site-default",je=[Ie,Ve,Pe],uo=0,po=1,Ge=2,_o=3,Me="G",$e="PG-13",Be="R-17",We="uploader",Ye="rating",Qe="privacy"},"../../packages/videopress/src/client/state/index.js":(ao,oe,k)=>{var ze;k.d(oe,{tT:()=>n.tT});var te=k("../../../node_modules/.pnpm/debug@4.3.4/node_modules/debug/src/browser.js"),ne=k.n(te),v=k("../../../node_modules/.pnpm/@wordpress+api-fetch@6.44.0/node_modules/@wordpress/api-fetch/build-module/index.js"),R=k("../../../node_modules/.pnpm/@wordpress+url@3.48.0/node_modules/@wordpress/url/build-module/add-query-args.js"),se=k("../../../node_modules/.pnpm/@wordpress+i18n@4.47.0/node_modules/@wordpress/i18n/build-module/index.js"),ie=k("../../../node_modules/.pnpm/tus-js-client@2.3.0/node_modules/tus-js-client/lib.esm/browser/index.js");const re=se.__,L={},G=function(){return new Promise(function(e,o){apiFetch({path:"/wpcom/v2/videopress/upload-jwt",method:"POST"}).then(t=>{e({token:t.upload_token,blogId:t.upload_blog_id,url:t.upload_url})}).catch(t=>{o(t)})})},de=({file:e,onProgress:o,onSuccess:t,onError:i,data:r})=>{const s=new tus.Upload(e,{onError:i,onProgress:o,endpoint:r.url,removeFingerprintOnSuccess:!0,withCredentials:!1,autoRetry:!0,overridePatchMethod:!1,chunkSize:1e7,metadata:{filename:e.name,filetype:e.type},retryDelays:[0,1e3,3e3,5e3,1e4],onAfterResponse:function(d,c){if(c.getStatus()>=400)return;const u="x-videopress-upload-guid",g="x-videopress-upload-media-id",m="x-videopress-upload-src-url",I=c.getHeader(u),E=c.getHeader(g),V=c.getHeader(m);if(I&&E&&V){t&&t({id:Number(E),guid:I,src:V},e);return}const y={"x-videopress-upload-key-token":"token","x-videopress-upload-key":"key"},P={};Object.keys(y).forEach(function(O){const f=c.getHeader(O);f&&(P[y[O]]=f)}),P.key&&P.token&&(L[P.key]=P.token)},onBeforeRequest:function(d){const c=d._method;["HEAD","OPTIONS"].indexOf(c)>=0&&(d._method="GET",d.setHeader("X-HTTP-Method-Override",c)),["DELETE","PUT","PATCH"].indexOf(c)>=0&&(d._method="POST",d.setHeader("X-HTTP-Method-Override",c)),d._xhr.open(d._method,d._url,!0);for(const u in d._headers)d.setHeader(u,d._headers[u]);if(c==="POST")if(!!r.token)d.setHeader("x-videopress-upload-token",r.token);else throw"should never happen";if(["OPTIONS","GET","HEAD","DELETE","PUT","PATCH"].indexOf(c)>=0){const m=new URL(d._url).pathname.split("/"),I=m[m.length-1];if(L[I])d.setHeader("x-videopress-upload-token",L[I]);else if(c==="HEAD")return G().then(E=>(L[I]=E.token,d.setHeader("x-videopress-upload-token",E.token),d))}return Promise.resolve(d)}});return s.findPreviousUploads().then(function(d){d.length&&s.resumeFromPreviousUpload(d[0]),s.start()}),s},M=e=>{const o=`videopress/v1/upload/${e}`;return new Promise((t,i)=>{(0,v.Z)({path:o,method:"POST"}).then(r=>{r.status==="uploading"||r.status==="new"||r.status==="resume"?M(e).then(t).catch(i):r.status==="complete"?t({guid:r.uploaded_details.guid,id:r.uploaded_details.media_id,src:r.uploaded_details.upload_src}):r.status==="error"?i({data:{message:r.error}}):i({data:{message:re("Unexpected error uploading video.","jetpack-videopress-pkg")}})}).catch(r=>{i({data:{message:r==null?void 0:r.message}})})})},Se=({onError:e,onProgress:o,onSuccess:t})=>{const[i,r]=useState({}),[s,d]=useState(null);return useEffect(()=>{G().then(r).catch(u=>{d(u),e==null||e(u)})},[]),[u=>de({file:u,onProgress:o,onSuccess:t,onError:e,data:i}),i,s]},ce=["upload","playback","upload-jwt"],ye=null,F=ne()("videopress:get-media-token"),ae=1e3*60*60*24,le=function(e,o={}){const{id:t=0,guid:i,subscriptionPlanId:r=0,adminAjaxAPI:s,filename:d}=o;return new Promise(function(c,u){var I;const g=s||((I=window.videopressAjax)==null?void 0:I.ajaxUrl)||(window==null?void 0:window.ajaxurl)||"/wp-admin/admin-ajax.php";if(!ce.includes(e))return u("Invalid scope");const m={action:"videopress-get-playback-jwt"};switch(e){case"upload":m.action="videopress-get-upload-token",d&&(m.filename=d);break;case"upload-jwt":m.action="videopress-get-upload-jwt";break;case"playback":m.action="videopress-get-playback-jwt",m.guid=i,m.post_id=String(t),m.subscription_plan_id=r;break}fetch(g,{method:"POST",credentials:"same-origin",body:new URLSearchParams(m)}).then(E=>{if(!E.ok)throw new Error("Network response was not ok");return E.json()}).then(E=>{if(!E.success)throw new Error("Token is not achievable");switch(e){case"upload":case"upload-jwt":c({token:E.data.upload_token,blogId:E.data.upload_blog_id,url:E.data.upload_action_url});break;case"playback":c({token:E.data.jwt});break}}).catch(()=>{console.warn("Token is not achievable"),c({token:null})})})};async function ue(e,o={}){var m;const{id:t=0,guid:i=0,flushToken:r}=o,s=`vpc-${e}-${t}-${i}`,d=((m=window==null?void 0:window.videopressAjax)==null?void 0:m.context)||"main";let c;const u=localStorage.getItem(s);if(r)F("(%s) Flushing %o token",d,s),localStorage.removeItem(s);else try{if(u){if(c=await JSON.parse(u),c&&c.expire>Date.now())return F("(%s) Providing %o token from the store",d,s),c.data;F("(%s) Token %o expired. Clean.",d,s),localStorage.removeItem(s)}}catch(I){F("Invalid token in the localStore")}const g=await le(e,o);return e==="playback"&&(g!=null&&g.token)&&(F("(%s) Storing %o token",d,s),localStorage.setItem(s,JSON.stringify({data:g,expire:Date.now()+ae}))),F("(%s) Providing %o token from request/response",d,s),g}const $=ue,N={},pe=({file:e,tokenData:o,onProgress:t,onSuccess:i,onError:r})=>{const s=new ie.gq(e,{onError:r,onProgress:t,endpoint:o.url,removeFingerprintOnSuccess:!0,withCredentials:!1,autoRetry:!0,overridePatchMethod:!1,chunkSize:1e7,metadata:{filename:e.name,filetype:e.type},retryDelays:[0,1e3,3e3,5e3,1e4],onBeforeRequest:function(d){const c=d._method;if(["HEAD","OPTIONS"].indexOf(c)>=0&&(d._method="GET",d.setHeader("X-HTTP-Method-Override",c)),["DELETE","PUT","PATCH"].indexOf(c)>=0&&(d._method="POST",d.setHeader("X-HTTP-Method-Override",c)),d._xhr.open(d._method,d._url,!0),Object.keys(d._headers).map(function(u){d.setHeader(u,d._headers[u])}),c==="POST")if(!!o.token)d.setHeader("x-videopress-upload-token",o.token);else throw"should never happen";if(["OPTIONS","GET","HEAD","DELETE","PUT","PATCH"].indexOf(c)>=0){const m=new URL(d._url).pathname.split("/"),I=m[m.length-1];if(N[I])d.setHeader("x-videopress-upload-token",N[I]);else if(c==="HEAD")return $("upload-jwt").then(E=>(N[I]=E.token,d.setHeader("x-videopress-upload-token",E.token),d))}return Promise.resolve(d)},onAfterResponse:function(d,c){if(c.getStatus()>=400)return;const u="x-videopress-upload-guid",g="x-videopress-upload-media-id",m="x-videopress-upload-src-url",I=c.getHeader(u),E=c.getHeader(g),V=c.getHeader(m);if(I&&E&&V){i&&i({id:Number(E),guid:I,src:V},e);return}const y={"x-videopress-upload-key-token":"token","x-videopress-upload-key":"key"},P={};Object.keys(y).forEach(function(O){const f=c.getHeader(O);f&&(P[y[O]]=f)}),P.key&&P.token&&(N[P.key]=P.token)}});return s.findPreviousUploads().then(function(d){d.length&&s.resumeFromPreviousUpload(d[0]),s.start()}),s},B=()=>{const e=new Uint32Array(10);crypto.getRandomValues(e);const o=performance.now().toString(36),t=Array.from(e).map(i=>i.toString(36)).join("");return`${o}-${t}`};var n=k("../../packages/videopress/src/client/state/constants.js");const x=e=>{const{media_details:o,id:t,jetpack_videopress:i,jetpack_videopress_guid:r}=e,{videopress:s,width:d,height:c}=o,{title:u,description:g,caption:m,rating:I,allow_download:E,display_embed:V,privacy_setting:y,needs_playback_token:P,is_private:O}=i,{original:f,poster:j,upload_date:Y,duration:Q,file_url_base:K,finished:Z,files:J={dvd:{original_img:""}}}=s||{},{dvd:b}=J,X=b!=null&&b.original_img?`${K.https}${b.original_img}`:void 0,z=f==null?void 0:f.split("/").slice(-1)[0];return{id:t,guid:r,title:u,description:g,caption:m,url:f,uploadDate:Y,duration:Q,isPrivate:O,posterImage:j,allowDownload:E,displayEmbed:V,rating:I,privacySetting:y,needsPlaybackToken:P,width:d,height:c,poster:{src:j},thumbnail:X,finished:Z,filename:z}},_e=e=>{var o;return(o=e==null?void 0:e.map)==null?void 0:o.call(e,x)},ge=e=>{const{media_details:o,id:t,jetpack_videopress:i,source_url:r,date:s}=e,{width:d,height:c,length:u}=o,{title:g,description:m,caption:I}=i;return{id:t,title:g,description:m,caption:I,width:d,height:c,url:r,uploadDate:s,duration:u}},me=e=>e.map(ge),Ee=(e,o)=>n.Vz[e]===n.$A?!1:n.Vz[e]===n.UJ?!0:o,H=async e=>{const o=await(0,v.Z)({path:(0,R.f)(`${n.u_}/${e==null?void 0:e.id}`)}),t=x(o);return(t==null?void 0:t.posterImage)!==null&&(t==null?void 0:t.posterImage)!==""?Promise.resolve(t):new Promise((i,r)=>{setTimeout(()=>{H(e).then(i).catch(r)},2e3)})},fo={setIsFetchingVideos:e=>({type:n.QC,isFetching:e}),setFetchVideosError:e=>({type:n.tH,error:e}),setVideosQuery:e=>({type:n.Dj,query:e}),setVideosPagination:e=>({type:n.H,pagination:e}),setVideosFilter:(e,o,t)=>({type:n.$L,filter:e,value:o,isActive:t}),setVideos:e=>({type:n.p0,videos:e}),dismissFirstVideoPopover:()=>({type:n.pD}),setLocalVideos:e=>({type:n.FP,videos:e}),setIsFetchingLocalVideos:e=>({type:n.ZP,isFetching:e}),setLocalVideosQuery:e=>({type:n.Ps,query:e}),setLocalVideosPagination:e=>({type:n.Vc,pagination:e}),setVideosStorageUsed:e=>({type:n.vP,used:e}),setVideo:(e,o=!1)=>({type:n.Et,video:e,addAtEnd:o}),setIsFetchingUploadedVideoCount:e=>({type:n.z$,isFetchingUploadedVideoCount:e}),setUploadedVideoCount:e=>({type:n.Wi,uploadedVideoCount:e}),setVideoPrivacy:({id:e,privacySetting:o})=>({type:n.NL,id:e,privacySetting:o}),updateVideoPrivacy:(e,o)=>async({dispatch:t,select:i,resolveSelect:r})=>{const s=Number(o);if(isNaN(s))throw new Error(`Invalid privacy level: '${o}'`);if(0>s||s>=n.Vz.length)throw new Error(`Invalid privacy level: '${o}'`);if(o===1){const d=await i.getVideo(e);await r.getPlaybackToken(d==null?void 0:d.guid)}t.setVideoPrivacy({id:e,privacySetting:s});try{const d=await(0,v.Z)({path:n.tb,method:"POST",data:{id:e,privacy_setting:s}});if((d==null?void 0:d.data)!==200)return;const{videoPressVideosPrivateForSite:c}=i.getVideoPressSettings();return t.updateVideoIsPrivate(e,Ee(s,c)),t({type:n.RB,id:e,privacySetting:s})}catch(d){console.error(d)}},removeVideo:e=>({type:n.Og,id:e}),deleteVideo:e=>async({dispatch:o,select:t})=>{o.removeVideo(e);let i={type:n.tw,id:e,hasBeenDeleted:!1,video:{}};try{const s=await(0,v.Z)({path:`${n.u_}/${e}`,method:"DELETE",data:{id:e,force:!0}});s!=null&&s.deleted&&(i={...i,hasBeenDeleted:!0,video:s==null?void 0:s.previous})}catch(s){console.error(s)}finally{o(i)}t.getProcessedAllVideosBeingRemoved()&&(o({type:n.wI}),o({type:n.Zp}))},uploadVideo:e=>async({dispatch:o})=>{const t=B(),i=()=>{};o({type:n.x_,id:t,title:e==null?void 0:e.name});const r=await $("upload-jwt");pe({tokenData:r,file:e,onError:i,onProgress:(c,u)=>{o({type:n.dY,id:t,bytesSent:c,bytesTotal:u})},onSuccess:async c=>{o({type:n.fi,id:t,data:c});const u=await H(c);o({type:n.pI,video:u})}})},uploadVideoFromLibrary:e=>async({dispatch:o})=>{const t=B();o({type:n.x_,id:t,title:e==null?void 0:e.title});const i=await M(e==null?void 0:e.id);o({type:n.W_,id:e==null?void 0:e.id}),o({type:n.fi,id:t,data:i});const r=await H(i);o({type:n.pI,video:r})},setIsFetchingPurchases:e=>({type:n.CM,isFetching:e}),setPurchases:e=>({type:n.z8,purchases:e}),updateVideoPoster:(e,o,t)=>async({dispatch:i,select:r,resolveSelect:s})=>{var I,E;const d=`${n.FY}/${o}/poster`,c=await r.getVideo(e),u=async()=>{if(!c.needsPlaybackToken)return null;const V=await s.getPlaybackToken(c.guid);return V==null?void 0:V.token},g=(V,y)=>!V||!y?V:`${V}?metadata_token=${y}`,m=()=>{setTimeout(async()=>{var V,y;try{const P=await(0,v.Z)({path:d,method:"GET"});if((V=P==null?void 0:P.data)!=null&&V.generating)m();else{const O=await u(),f=(y=P==null?void 0:P.data)==null?void 0:y.poster;i({type:n.Vm,id:e,poster:g(f,O)}),(0,v.Z)({path:n.tb,method:"POST",data:{id:e,poster:f}})}}catch(P){console.error(P)}},2e3)};try{i({type:n.Db,id:e});const V=c.duration-t.at_time;V<50&&(t.at_time-=V+50);const y=await(0,v.Z)({method:"POST",path:d,data:t});if((I=y==null?void 0:y.data)!=null&&I.generating){m();return}const P=await u(),O=g((E=y==null?void 0:y.data)==null?void 0:E.poster,P);return i({type:n.Vm,id:e,poster:O})}catch(V){console.error(V)}},setUsers:e=>({type:n.b1,users:e}),setUsersPagination:e=>({type:n.IN,pagination:e}),setIsFetchingPlaybackToken:e=>({type:n.TD,isFetching:e}),setPlaybackToken:e=>({type:n.El,playbackToken:e}),expirePlaybackToken:e=>({type:n.o1,guid:e}),setVideoPressSettings:e=>({type:n.WJ,videoPressSettings:e}),updateVideoPressSettings:e=>async({dispatch:o})=>{if(!e)return;const t={force:!0};typeof e.videoPressVideosPrivateForSite=="boolean"&&(t.videopress_videos_private_for_site=e.videoPressVideosPrivateForSite);try{return o.setVideoPressSettings(e),await(0,v.Z)({path:n.uo,method:"PUT",data:t})}catch(i){console.error(i)}},updateVideoIsPrivate:(e,o)=>({type:n.jV,id:e,isPrivate:o})};var go=k("../../../node_modules/.pnpm/@wordpress+data@9.17.0_react@18.2.0/node_modules/@wordpress/data/build-module/index.js"),Ke=k("../../../node_modules/.pnpm/@wordpress+url@3.48.0/node_modules/@wordpress/url/build-module/clean-for-slug.js");function Te(){return{order:"desc",orderBy:"date",itemsPerPage:6,page:1,type:"video/videopress"}}const mo=(e,o)=>{var t,i,r,s,d,c,u,g,m,I,E,V,y,P,O,f,j,Y,Q,K,Z,J,b,X,z,qe,eo,oo,to,no,so,io,ro,co;switch(o.type){case n.QC:return{...e,isFetching:o.isFetching};case n.tH:{const{error:l}=o;return{...e,isFetching:!1,error:l}}case n.Dj:return{...e,query:{...e.query,...o.query},_meta:{...e._meta,relyOnInitialState:!1}};case n.H:return{...e,pagination:{...e.pagination,...o.pagination},_meta:{...e._meta,relyOnInitialState:!1}};case n.$L:{const{filter:l,value:p,isActive:a}=o;return{...e,filter:{...e.filter,[l]:{...((t=e.filter)==null?void 0:t[l])||{},[p]:a}},_meta:{...e._meta,relyOnInitialState:!1}}}case n.p0:{const{videos:l}=o;return{...e,items:l,isFetching:!1}}case n.Et:{const{video:l,addAtEnd:p=!1}=o,a=[...(i=e.items)!=null?i:[]],_=a.findIndex(T=>T.id===l.id);return _===-1?p?a.push(l):a.unshift(l):a[_]={...a[_],...l},{...e,isFetching:!1,items:a}}case n.NL:{const{id:l,privacySetting:p}=o,a=[...(r=e.items)!=null?r:[]],_=a.findIndex(A=>A.id===l);if(_<0)return e;const T=a[_].privacySetting;a[_]={...a[_],privacySetting:p};const S={...(d=(s=e._meta)==null?void 0:s.items)!=null?d:[]},h=(c=S[l])!=null?c:{};return{...e,items:a,_meta:{...e._meta,items:{...S,[l]:{...h,isUpdatingPrivacy:!0,hasBeenUpdatedPrivacy:!1,prevPrivacySetting:T}}}}}case n.RB:{const{id:l}=o,p={...(g=(u=e._meta)==null?void 0:u.items)!=null?g:[]};if(!(p!=null&&p[l]))return e;const a=(m=p[l])!=null?m:{};return{...e,_meta:{...e._meta,items:{...p,[l]:{...a,isUpdatingPrivacy:!1,hasBeenUpdatedPrivacy:!0,prevPrivacySetting:null}}}}}case n.jV:{const{id:l,isPrivate:p}=o,a=[...(I=e.items)!=null?I:[]],_=a.findIndex(T=>T.id===l);return _<0?e:(a[_]={...a[_],isPrivate:p},{...e,items:a})}case n.Og:{const{id:l}=o,{items:p=[]}=e;if(p.findIndex(S=>S.id===l)<0)return e;const _={...(V=(E=e._meta)==null?void 0:E.items)!=null?V:[]},T=(y=_[l])!=null?y:{};return{...e,_meta:{...e._meta,videosBeingRemoved:[{id:l,processed:!1,deleted:!1},...(P=e._meta.videosBeingRemoved)!=null?P:[]],items:{..._,[l]:{...T,isDeleting:!0}}}}}case n.tw:{const{id:l,hasBeenDeleted:p,video:a}=o,_=((O=e==null?void 0:e._meta)==null?void 0:O.items)||[],T=_[l]||{},S=[...(f=e._meta.videosBeingRemoved)!=null?f:[]],h=S.findIndex(D=>D.id===l);if(!T||h<0)return e;S[h].processed=!0,S[h].deleted=p;const A=S.filter(D=>!D.processed).length===0;let w=(j=e.uploadedVideoCount)!=null?j:0;if(A){const D=S.filter(C=>C.deleted).length;w=w-D}return{...e,uploadedVideoCount:w,_meta:{...e._meta,videosBeingRemoved:S,processedAllVideosBeingRemoved:A,items:{..._,[l]:{...T,hasBeenDeleted:p,deletedVideo:a}}}}}case n.Zp:return{...e,_meta:{...e._meta,videosBeingRemoved:[],relyOnInitialState:!1}};case n.wI:{const{items:l=[],query:p={},pagination:a={},_meta:_={}}=e,{videosBeingRemoved:T=[]}=_,S=T.filter(ee=>ee.deleted).length,h=(l==null?void 0:l.length)===S,A=(Y=p==null?void 0:p.page)!=null?Y:1,w=(Q=a==null?void 0:a.totalPages)!=null?Q:1,D=a==null?void 0:a.total,C=h&&A>1?A-1:A,q=h&&w>1?w-1:w;return{...e,query:{...p,page:C},pagination:{...a,total:D-1,totalPages:q}}}case n.vP:return{...e,storageUsed:o.used};case n.z$:return{...e,isFetchingUploadedVideoCount:o.isFetchingUploadedVideoCount};case n.Wi:return{...e,uploadedVideoCount:o.uploadedVideoCount,isFetchingUploadedVideoCount:!1};case n.x_:{const{id:l,title:p}=o,a=(e==null?void 0:e._meta)||{},_=(a==null?void 0:a.items)||{},T=(0,Ke.J)(p);return{...e,_meta:{...a,items:{..._,[l]:{title:T,uploading:!0}}}}}case n.fi:{const{id:l,data:p}=o,a=(K=e==null?void 0:e.query)!=null?K:Te(),_={...e.pagination},T=[...(Z=e==null?void 0:e.items)!=null?Z:[]],S=(e==null?void 0:e._meta)||{},h=Object.assign({},(S==null?void 0:S.items)||{}),A=((X=(b=(J=p==null?void 0:p.src)==null?void 0:J.split("/"))==null?void 0:b.slice(-1))==null?void 0:X[0])||((z=h[l])==null?void 0:z.title)||"",w=(0,Ke.J)(A);let D=(qe=e==null?void 0:e.uploadedVideoCount)!=null?qe:0,C=(eo=e==null?void 0:e.firstUploadedVideoId)!=null?eo:null,q=(oo=e==null?void 0:e.firstVideoProcessed)!=null?oo:!1,ee=(to=e==null?void 0:e.dismissedFirstVideoPopover)!=null?to:!1;return D===0&&(C=p.id,q=!1,ee=!1),(a==null?void 0:a.page)===1&&!(a!=null&&a.search)&&(D=((no=e==null?void 0:e.uploadedVideoCount)!=null?no:0)+1,_.total=D,_.totalPages=Math.ceil(D/(a==null?void 0:a.itemsPerPage)),T.unshift({id:p.id,guid:p.guid,url:p.src,title:w,posterImage:null,finished:!1})),delete h[l],{...e,items:T,uploadedVideoCount:D,firstUploadedVideoId:C,firstVideoProcessed:q,dismissedFirstVideoPopover:ee,pagination:_,_meta:{...S,items:h}}}case n.pI:{const{video:l}=o,p=[...(so=e==null?void 0:e.items)!=null?so:[]],a=p.findIndex(S=>S.id===l.id),_=(io=e==null?void 0:e.firstUploadedVideoId)!=null?io:null;let T=(ro=e==null?void 0:e.firstVideoProcessed)!=null?ro:null;return l.id===_&&(T=!0),a===-1?{...e,firstVideoProcessed:T}:(p[a]=l,{...e,firstVideoProcessed:T,items:p})}case n.Db:{const{id:l}=o,p=(e==null?void 0:e._meta)||{},a=(p==null?void 0:p.items)||{},_=a[l]||{};return{...e,_meta:{...p,items:{...a,[l]:{..._,isUpdatingPoster:!0}}}}}case n.Vm:{const{id:l,poster:p}=o,a=[...(co=e.items)!=null?co:[]],_=(e==null?void 0:e._meta)||{},T=(_==null?void 0:_.items)||{},S=a.findIndex(h=>h.id===l);return S>=0&&(a[S]={...a[S],posterImage:p}),{...e,items:a,_meta:{..._,items:{...T,[l]:{isUpdatingPoster:!1}}}}}case n.dY:{const{id:l,bytesSent:p,bytesTotal:a}=o,_=(e==null?void 0:e._meta)||{},T=(_==null?void 0:_.items)||{},S=T[l]||{},h=a>0?p/a:0;return{...e,_meta:{..._,items:{...T,[l]:{...S,uploadProgress:h}}}}}case n.pD:return{...e,dismissedFirstVideoPopover:!0,firstUploadedVideoId:null};default:return e}},Eo=(e,o)=>{var t;switch(o.type){case n.FP:{const{videos:i}=o;return{...e,items:i,isFetching:!1}}case n.ZP:return{...e,isFetching:o.isFetching};case n.Ps:return{...e,query:{...e.query,...o.query},_meta:{...e._meta,relyOnInitialState:!1}};case n.Vc:return{...e,pagination:{...e.pagination,...o.pagination},_meta:{...e._meta,relyOnInitialState:!1}};case n.W_:{const{id:i}=o,r=[...(t=e==null?void 0:e.items)!=null?t:[]],s=r.findIndex(d=>d.id===i);return s===-1?e:(r[s]={...r[s],isUploadedToVideoPress:!0},{...e,items:r,isFetching:!1})}}return e},Io=(e,o)=>{switch(o.type){case n.b1:return{...e,items:o.users};case n.IN:return{...e,pagination:{...(e==null?void 0:e.pagination)||{},...o.pagination}};default:return e}},Vo=(e,o)=>{switch(o.type){case n.CM:return{...e,isFetching:o.isFetching};case n.z8:return{...e,items:o.purchases,isFetching:!1};default:return e}},Po=(e,o)=>{var t,i;switch(o.type){case n.TD:return{...e,isFetching:o.isFetching};case n.El:{const{playbackToken:r}=o,s=[...(t=e.items)!=null?t:[]],d=s.findIndex(c=>c.guid===r.guid);return d===-1?s.unshift(r):s[d]={...s[d],...r},{...e,items:s,isFetching:!1}}case n.o1:{const{guid:r}=o,s=[...(i=e.items)!=null?i:[]],d=s.findIndex(c=>c.guid===r);return d>-1&&s.splice(d,1),{...e,items:s,isFetching:!1}}default:return e}},To=(e,o)=>{switch(o.type){case n.WJ:{const{videoPressSettings:t}=o;return{...e,...t}}default:return e}},ho=(0,go.UY)({videos:mo,localVideos:Eo,purchases:Vo,users:Io,playbackTokens:Po,siteSettings:To}),vo=null,{apiRoot:W}=(window==null?void 0:window.jetpackVideoPressInitialState)||{};async function Ze(e,o,t){if(!e.needsPlaybackToken)return e;let i=await o.getPlaybackToken(e.guid);return i&&Number(i.issueTime)+864e5<Date.now()&&(await t.expirePlaybackToken(e.guid),i=await o.getPlaybackToken(e.guid)),/metadata_token=/.test(e.posterImage)||(e.posterImage+=`?metadata_token=${i.token}`),/metadata_token=/.test(e.thumbnail)||(e.thumbnail+=`?metadata_token=${i.token}`),/metadata_token=/.test(e.url)||(e.url+=`?metadata_token=${i.token}`),e}const bo={getStorageUsed:{isFulfilled:e=>{var o,t;return(t=(o=e==null?void 0:e.videos)==null?void 0:o._meta)==null?void 0:t.relyOnInitialState},fulfill:()=>async({dispatch:e})=>{var o;try{const t=await(0,v.Z)({path:n.JV});if(!((o=t==null?void 0:t.options)!=null&&o.videopress_storage_used))return;const i=t.options.videopress_storage_used?Math.round(Number(t.options.videopress_storage_used)*1e3*1e3):0;e.setVideosStorageUsed(i)}catch(t){console.error(t)}}},getUploadedVideoCount:{isFulfilled:e=>{var o,t;return(t=(o=e==null?void 0:e.videos)==null?void 0:o._meta)==null?void 0:t.relyOnInitialState},fulfill:()=>async({dispatch:e})=>{const o={per_page:1,media_type:"video",mime_type:"video/videopress"};e.setIsFetchingUploadedVideoCount(!0);try{const t=await fetch((0,R.f)(`${W}${n.u_}`,o)),i=Number(t.headers.get("X-WP-Total"));return e.setUploadedVideoCount(i),i}catch(t){console.error(t)}},shouldInvalidate:e=>e.type===n.fi||e.type===n.Zp},getVideos:{isFulfilled:e=>{var o,t;return(t=(o=e==null?void 0:e.videos)==null?void 0:o._meta)==null?void 0:t.relyOnInitialState},fulfill:()=>async({dispatch:e,select:o,resolveSelect:t})=>{e.setIsFetchingVideos(!0);let i=o.getVideosQuery();i||(i=Te(),e.setVideosQuery(i));const r={order:i.order,orderby:i.orderBy,page:i.page,per_page:i.itemsPerPage,media_type:"video",mime_type:"video/videopress"};typeof i.search=="string"&&i.search.length>0&&(r.search=i.search);const s=o.getVideosFilter(),d=Object.keys((s==null?void 0:s.rating)||{}).filter(g=>s.rating[g]).join(",");d!=null&&d.length&&(r.videopress_rating=d);const c=Object.keys((s==null?void 0:s.privacy)||{}).filter(g=>s.privacy[g]).join(",");c!=null&&c.length&&(r.videopress_privacy_setting=c);const u=Object.keys((s==null?void 0:s.uploader)||{}).filter(g=>s.uploader[g]).join(",");u!=null&&u.length&&(r.author=u);try{const g=await fetch((0,R.f)(`${W}${n.u_}`,r)),m=Number(g.headers.get("X-WP-Total")),I=Number(g.headers.get("X-WP-TotalPages"));e.setVideosPagination({total:m,totalPages:I});const E=await g.json(),V=await Promise.all(_e(E).map(async y=>await Ze(y,t,e)));return e.setVideos(V),E}catch(g){console.error(g)}},shouldInvalidate:({type:e})=>e===n.Dj||e===n.Zp||e===n.$L},getVideo:{isFulfilled:(e,o)=>{var r,s;if(!o||typeof o=="string")return!0;const i=((r=e.videos.items)!=null?r:[]).find(({id:d})=>d===o);return i&&i.needsPlaybackToken?!!(((s=e==null?void 0:e.playbackTokens)==null?void 0:s.items)||[]).find(u=>(u==null?void 0:u.guid)===i.guid):i},fulfill:(e,o=!1)=>async({dispatch:t,resolveSelect:i})=>{t.setIsFetchingVideos(!0);try{const r=await(0,v.Z)({path:(0,R.f)(`${n.u_}/${e}`)}),s=await Ze(x(r),i,t);return t.setVideo(s,o),r}catch(r){console.error(r)}}},getLocalVideos:{isFulfilled:e=>{var o,t;return(t=(o=e==null?void 0:e.localVideos)==null?void 0:o._meta)==null?void 0:t.relyOnInitialState},fulfill:()=>async({dispatch:e,select:o})=>{let t=o.getLocalVideosQuery();e.setIsFetchingLocalVideos(!0),t||(t=Te(),e.setVideosQuery(t));const i={order:t.order,orderby:t.orderBy,page:t.page,per_page:t.itemsPerPage,media_type:"video",no_videopress:!0};typeof t.search=="string"&&t.search.length>0&&(i.search=t.search);try{const r=await fetch((0,R.f)(`${W}${n.u_}`,i)),s=Number(r.headers.get("X-WP-Total")),d=Number(r.headers.get("X-WP-TotalPages"));e.setLocalVideosPagination({total:s,totalPages:d});const c=await r.json();return e.setLocalVideos(me(c)),c}catch(r){console.error(r)}},shouldInvalidate:e=>e.type===n.Ps},getUsers:{isFulfilled:e=>{var o,t;return(t=(o=e==null?void 0:e.users)==null?void 0:o._meta)==null?void 0:t.relyOnInitialState},fulfill:()=>async({dispatch:e})=>{e.setIsFetchingLocalVideos(!0);try{const o=await fetch(`${W}${n.Kc}`),t=Number(o.headers.get("X-WP-Total")),i=Number(o.headers.get("X-WP-TotalPages"));e.setUsersPagination({total:t,totalPages:i});const r=await o.json();return r!=null&&r.length?(e.setUsers(r.map(s=>({id:s.id,name:s.name,slug:s.slug,description:s.description,link:s.link,avatar:s.avatar_urls}))),r):void 0}catch(o){console.error(o)}}},getPlaybackToken:{isFulfilled:(e,o)=>{var i,r;const t=(r=(i=e==null?void 0:e.playbackTokens)==null?void 0:i.items)!=null?r:[];return t==null?void 0:t.some(s=>(s==null?void 0:s.guid)===o)},fulfill:e=>async({dispatch:o})=>{o.setIsFetchingPlaybackToken(!0);try{const t=await(0,v.Z)({path:(0,R.f)(`${n.qP}/${e}`),method:"POST"}),i={guid:e,token:t.playback_token,issueTime:Date.now()};return o.setPlaybackToken(i),i}catch(t){console.error(t)}},shouldInvalidate:(e,o)=>e.type===n.o1&&e.guid===o},getVideoPressSettings:{isFulfilled:e=>(e==null?void 0:e.siteSettings)!==void 0,fulfill:()=>async({dispatch:e})=>{try{const{videopress_videos_private_for_site:o}=await(0,v.Z)({path:(0,R.f)(`${n.uo}`),method:"GET"}),t={videoPressVideosPrivateForSite:o};return e.setVideoPressSettings(t),t}catch(o){console.error(o)}}}},Je=e=>{var o;return((o=e==null?void 0:e.videos)==null?void 0:o.items)||[]},dt={getVideos:Je,getUploadingVideos:e=>{var t,i;const o=((i=(t=e==null?void 0:e.videos)==null?void 0:t._meta)==null?void 0:i.items)||{};return Object.keys(o||{}).map(r=>({...o[r],id:r})).filter(r=>r.uploading)},getVideosQuery:e=>{var o;return(o=e==null?void 0:e.videos)==null?void 0:o.query},getPagination:e=>{var o;return(o=e==null?void 0:e.videos)==null?void 0:o.pagination},getVideosFilter:e=>{var o;return(o=e==null?void 0:e.videos)==null?void 0:o.filter},getUploadedVideoCount:e=>{var o;return(o=e==null?void 0:e.videos)==null?void 0:o.uploadedVideoCount},getIsFetching:e=>{var o;return(o=e==null?void 0:e.videos)==null?void 0:o.isFetching},getIsFetchingUploadedVideoCount:e=>{var o;return(o=e==null?void 0:e.videos)==null?void 0:o.isFetchingUploadedVideoCount},getStorageUsed:e=>{var o;return{storageUsed:(o=e==null?void 0:e.videos)==null?void 0:o.storageUsed}},getFirstUploadedVideoId:e=>{var o;return(o=e==null?void 0:e.videos)==null?void 0:o.firstUploadedVideoId},getFirstVideoProcessed:e=>{var o;return(o=e==null?void 0:e.videos)==null?void 0:o.firstVideoProcessed},getDismissedFirstVideoPopover:e=>{var o;return(o=e==null?void 0:e.videos)==null?void 0:o.dismissedFirstVideoPopover},getProcessedAllVideosBeingRemoved:e=>{var o,t;return(t=(o=e==null?void 0:e.videos)==null?void 0:o._meta)==null?void 0:t.processedAllVideosBeingRemoved},getLocalVideos:e=>{var o;return((o=e==null?void 0:e.localVideos)==null?void 0:o.items)||[]},getIsFetchingLocalVideos:e=>{var o;return(o=e==null?void 0:e.localVideos)==null?void 0:o.isFetching},getLocalVideosQuery:e=>{var o;return(o=e==null?void 0:e.localVideos)==null?void 0:o.query},getLocalPagination:e=>{var o;return(o=e==null?void 0:e.localVideos)==null?void 0:o.pagination},getUploadedLocalVideoCount:e=>{var o;return(o=e==null?void 0:e.localVideos)==null?void 0:o.uploadedVideoCount},getVideo:(e,o)=>Je(e).find(({id:r})=>r===o),getVideoStateMetadata:(e,o)=>{var r,s;return(((s=(r=e==null?void 0:e.videos)==null?void 0:r._meta)==null?void 0:s.items)||{})[o]||{}},getUsers:e=>{var o;return((o=e==null?void 0:e.users)==null?void 0:o.items)||[]},getUsersPagination:e=>{var o;return(o=e==null?void 0:e.users)==null?void 0:o.pagination},getPurchases:e=>{var o;return((o=e==null?void 0:e.purchases)==null?void 0:o.items)||[]},isFetchingPurchases:e=>{var o;return(o=e==null?void 0:e.purchases)==null?void 0:o.isFetching},getPlaybackToken:(e,o)=>{var r;return(((r=e==null?void 0:e.playbackTokens)==null?void 0:r.items)||[]).find(s=>(s==null?void 0:s.guid)===o)||{}},isFetchingPlaybackToken:e=>{var o;return(o=e==null?void 0:e.playbackTokens)==null?void 0:o.isFetching},getVideoPressSettings:e=>e==null?void 0:e.siteSettings},ct=null,So=ne()("videopress/media:state"),Xe=((ze=window.jetpackVideoPressInitialState)==null?void 0:ze.initialState)||{videos:{}},U=window.location.hash.split("?");(U==null?void 0:U[0])==="#/"&&(U!=null&&U[1])&&(U==null?void 0:U[1])!=="page=1"&&(Xe.videos.isFetching=!0);function at(){So("Initializing %o store",STORE_ID),storeHolder.mayBeInit(STORE_ID,{__experimentalUseThunks:!0,reducer,actions,selectors,resolvers,initialState:Xe})}}}]);})();
