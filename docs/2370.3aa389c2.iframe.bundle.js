"use strict";(()=>{(self.webpackChunk_automattic_jetpack_storybook=self.webpackChunk_automattic_jetpack_storybook||[]).push([[2370],{"../../packages/videopress/src/client/state/constants.js":(no,fe,D)=>{D.d(fe,{$N:()=>be,$s:()=>M,Aq:()=>Ie,B1:()=>_e,CR:()=>Se,Cj:()=>He,DE:()=>N,DX:()=>pe,Dv:()=>B,E9:()=>ae,GY:()=>Ue,H9:()=>me,IX:()=>ue,K:()=>ke,Ko:()=>De,LF:()=>je,Ms:()=>K,N1:()=>Ce,NS:()=>Ne,NX:()=>Ve,Ni:()=>ce,OU:()=>xe,QK:()=>de,RZ:()=>Ge,Rd:()=>Y,SH:()=>j,TC:()=>re,TI:()=>G,TZ:()=>Ae,UB:()=>X,WX:()=>ge,az:()=>Te,bT:()=>ie,c$:()=>he,d$:()=>H,en:()=>Re,h7:()=>we,k8:()=>W,kb:()=>Ee,kp:()=>Fe,o0:()=>Pe,p9:()=>v,pC:()=>L,pz:()=>ve,q2:()=>Le,qd:()=>w,u7:()=>le,v2:()=>R,wx:()=>n,zG:()=>$e});const Oe="videopress/media",x="/wp-admin/admin-ajax.php",v="wp/v2/users",M="wp/v2/media",R="wpcom/v2/videopress",ie="wpcom/v2/videopress/meta",re="wpcom/v2/videopress/playback-jwt",L="videopress/v1/settings",B="videopress/v1/site",de="SET_IS_FETCHING_VIDEOS",K="SET_VIDEOS_FETCH_ERROR",ve="SET_VIDEOS_QUERY",ce="SET_VIDEOS_PAGINATION",he="SET_VIDEOS",w="SET_VIDEOS_STORAGE_USED",ae="SET_UPLOADED_VIDEO_COUNT",le="SET_IS_FETCHING_UPLOADED_VIDEO_COUNT",ue="DISMISS_FIRST_VIDEO_POPOVER",X="SET_LOCAL_VIDEOS",W="SET_IS_FETCHING_LOCAL_VIDEOS",N="SET_LOCAL_VIDEOS_QUERY",pe="SET_LOCAL_VIDEOS_PAGINATION",ke="SET_LOCAL_VIDEO_UPLOADED",_e="SET_VIDEOS_FILTER",Y="SET_VIDEO",n="SET_VIDEO_PRIVACY",H="UPDATE_VIDEO_PRIVACY",ge="DELETE_VIDEO",me="REMOVE_VIDEO",Ee="FLUSH_DELETED_VIDEOS",Ie="UPDATE_PAGINATION_AFTER_DELETE",Ve="SET_VIDEO_UPLOADING",j="SET_VIDEO_UPLOADING_ERROR",G="SET_VIDEO_PROCESSING",De="SET_VIDEO_UPLOADED",Ae="SET_VIDEO_UPLOAD_PROGRESS",Re="SET_IS_FETCHING_PURCHASES",Ue="SET_PURCHASES",be="SET_IS_FETCHING_PLAYBACK_TOKEN",we="SET_PLAYBACK_TOKEN",Fe="EXPIRE_PLAYBACK_TOKEN",Le="SET_USERS",Ne="SET_USERS_PAGINATION",Ce="SET_UPDATING_VIDEO_POSTER",xe="UPDATE_VIDEO_POSTER",He="SET_VIDEOPRESS_SETTINGS",je="UPDATE_VIDEO_IS_PRIVATE",Ge="DISMISS_ERRORED_VIDEO",so=null,Te="public",Pe="private",Se="site-default",$e=[Te,Pe,Se],io=0,ro=1,co=2,ao=3,lo="G",uo="PG-13",po="R-17",_o="uploader",go="rating",mo="privacy"},"../../packages/videopress/src/client/state/index.js":(no,fe,D)=>{var We;var Oe=D("../../../node_modules/.pnpm/debug@4.3.4/node_modules/debug/src/browser.js"),x=D.n(Oe),v=D("../../../node_modules/.pnpm/@wordpress+api-fetch@7.9.0/node_modules/@wordpress/api-fetch/build-module/index.js"),M=D("../../../node_modules/.pnpm/@wordpress+i18n@5.9.0/node_modules/@wordpress/i18n/build-module/index.js"),R=D("../../../node_modules/.pnpm/@wordpress+url@4.9.0/node_modules/@wordpress/url/build-module/add-query-args.js"),ie=D("../../../node_modules/.pnpm/tus-js-client@4.1.0/node_modules/tus-js-client/lib.esm/browser/index.js");const re=M.__,L={},B=function(){return new Promise(function(e,o){apiFetch({path:"/wpcom/v2/videopress/upload-jwt",method:"POST"}).then(t=>{e({token:t.upload_token,blogId:t.upload_blog_id,url:t.upload_url})}).catch(t=>{o(t)})})},de=({file:e,onProgress:o,onSuccess:t,onError:s,data:r})=>{const i=new tus.Upload(e,{onError:s,onProgress:o,endpoint:r.url,removeFingerprintOnSuccess:!0,withCredentials:!1,autoRetry:!0,overridePatchMethod:!1,chunkSize:1e7,metadata:{filename:e.name,filetype:e.type},retryDelays:[0,1e3,3e3,5e3,1e4],onAfterResponse:function(d,c){if(c.getStatus()>=400)return;const p="x-videopress-upload-guid",_="x-videopress-upload-media-id",m="x-videopress-upload-src-url",S=c.getHeader(p),E=c.getHeader(_),I=c.getHeader(m);if(S&&E&&I){t&&t({id:Number(E),guid:S,src:I},e);return}const y={"x-videopress-upload-key-token":"token","x-videopress-upload-key":"key"},V={};Object.keys(y).forEach(function(h){const f=c.getHeader(h);f&&(V[y[h]]=f)}),V.key&&V.token&&(L[V.key]=V.token)},onBeforeRequest:function(d){const c=d._method;["HEAD","OPTIONS"].indexOf(c)>=0&&(d._method="GET",d.setHeader("X-HTTP-Method-Override",c)),["DELETE","PUT","PATCH"].indexOf(c)>=0&&(d._method="POST",d.setHeader("X-HTTP-Method-Override",c)),d._xhr.open(d._method,d._url,!0);for(const p in d._headers)d.setHeader(p,d._headers[p]);if(c==="POST")if(!!r.token)d.setHeader("x-videopress-upload-token",r.token);else throw"should never happen";if(["OPTIONS","GET","HEAD","DELETE","PUT","PATCH"].indexOf(c)>=0){const m=new URL(d._url).pathname.split("/"),S=m[m.length-1];if(L[S])d.setHeader("x-videopress-upload-token",L[S]);else if(c==="HEAD")return B().then(E=>(L[S]=E.token,d.setHeader("x-videopress-upload-token",E.token),d))}return Promise.resolve(d)}});return i.findPreviousUploads().then(function(d){d.length&&i.resumeFromPreviousUpload(d[0]),i.start()}),i},K=e=>{const o=`videopress/v1/upload/${e}`;return new Promise((t,s)=>{(0,v.A)({path:o,method:"POST"}).then(r=>{r.status==="uploading"||r.status==="new"||r.status==="resume"?K(e).then(t).catch(s):r.status==="complete"?t({guid:r.uploaded_details.guid,id:r.uploaded_details.media_id,src:r.uploaded_details.upload_src}):r.status==="error"?s({data:{message:r.error}}):s({data:{message:re("Unexpected error uploading video.","jetpack-videopress-pkg")}})}).catch(r=>{s({data:{message:r==null?void 0:r.message}})})})},ve=({onError:e,onProgress:o,onSuccess:t})=>{const[s,r]=useState({}),[i,d]=useState(null);return useEffect(()=>{B().then(r).catch(p=>{d(p),e==null||e(p)})},[]),[p=>de({file:p,onProgress:o,onSuccess:t,onError:e,data:s}),s,i]},ce=["upload","playback","upload-jwt"],he=null,w=x()("videopress:get-media-token"),ae=1e3*60*60*24,le=function(e,o={}){const{id:t=0,guid:s,subscriptionPlanId:r=0,adminAjaxAPI:i,filename:d}=o;return new Promise(function(c,p){var S;const _=i||((S=window.videopressAjax)==null?void 0:S.ajaxUrl)||(window==null?void 0:window.ajaxurl)||"/wp-admin/admin-ajax.php";if(!ce.includes(e))return p("Invalid scope");const m={action:"videopress-get-playback-jwt"};switch(e){case"upload":m.action="videopress-get-upload-token",d&&(m.filename=d);break;case"upload-jwt":m.action="videopress-get-upload-jwt";break;case"playback":m.action="videopress-get-playback-jwt",m.guid=s,m.post_id=String(t),m.subscription_plan_id=r;break}fetch(_,{method:"POST",credentials:"same-origin",body:new URLSearchParams(m)}).then(E=>{if(!E.ok)throw new Error("Network response was not ok");return E.json()}).then(E=>{if(!E.success)throw new Error("Token is not achievable");switch(e){case"upload":case"upload-jwt":c({token:E.data.upload_token,blogId:E.data.upload_blog_id,url:E.data.upload_action_url});break;case"playback":c({token:E.data.jwt});break}}).catch(()=>{console.warn("Token is not achievable"),c({token:null})})})};async function ue(e,o={}){var m;const{id:t=0,guid:s=0,flushToken:r}=o,i=`vpc-${e}-${t}-${s}`,d=((m=window==null?void 0:window.videopressAjax)==null?void 0:m.context)||"main";let c;const p=localStorage.getItem(i);if(r)w("(%s) Flushing %o token",d,i),localStorage.removeItem(i);else try{if(p){if(c=await JSON.parse(p),c&&c.expire>Date.now())return w("(%s) Providing %o token from the store",d,i),c.data;w("(%s) Token %o expired. Clean.",d,i),localStorage.removeItem(i)}}catch(S){w("Invalid token in the localStore")}const _=await le(e,o);return e==="playback"&&(_!=null&&_.token)&&(w("(%s) Storing %o token",d,i),localStorage.setItem(i,JSON.stringify({data:_,expire:Date.now()+ae}))),w("(%s) Providing %o token from request/response",d,i),_}const X=ue,W=x()("videopress:resumable-file-uploader"),N={},pe=e=>new URL(e).pathname.split("/").pop(),_e=({file:e,tokenData:o,onProgress:t,onSuccess:s,onError:r})=>{const i=new ie._O(e,{onError:r,onProgress:t,endpoint:o.url,removeFingerprintOnSuccess:!0,overridePatchMethod:!1,chunkSize:1e7,metadata:{filename:e.name,filetype:e.type},retryDelays:[0,1e3,3e3,5e3,1e4],onShouldRetry:function(d){return(d.originalResponse?d.originalResponse.getStatus():0)===400?(W("cleanup retry due to 400 error"),localStorage.removeItem(i._urlStorageKey),!1):!0},onBeforeRequest:async function(d){const c=d._method;if(["HEAD","OPTIONS"].indexOf(c)>=0&&(d._method="GET",d.setHeader("X-HTTP-Method-Override",c)),["DELETE","PUT","PATCH"].indexOf(c)>=0&&(d._method="POST",d.setHeader("X-HTTP-Method-Override",c)),d._xhr.open(d._method,d._url,!0),Object.keys(d._headers).forEach(function(p){d.setHeader(p,d._headers[p])}),c==="POST")if(!!o.token)d.setHeader("x-videopress-upload-token",o.token);else throw"should never happen";if(["OPTIONS","GET","HEAD","DELETE","PUT","PATCH"].indexOf(c)>=0){const p=pe(d._url);if(N[p])d.setHeader("x-videopress-upload-token",N[p]);else if(c==="HEAD"){const _=await X("upload-jwt");_!=null&&_.token&&(N[p]=_.token,d.setHeader("x-videopress-upload-token",_.token))}}},onAfterResponse:async function(d,c){if(c.getStatus()>=400){W("upload error");return}const p="x-videopress-upload-guid",_="x-videopress-upload-media-id",m="x-videopress-upload-src-url",S=c.getHeader(p),E=c.getHeader(_),I=c.getHeader(m);if(S&&E&&I){s&&s({id:Number(E),guid:S,src:I},e);return}const y={"x-videopress-upload-key-token":"token","x-videopress-upload-key":"key"},V={};Object.keys(y).forEach(function(h){const f=c.getHeader(h);f&&(V[y[h]]=f)}),V.key&&V.token&&(N[V.key]=V.token)}});return i.findPreviousUploads().then(function(d){d.length&&i.resumeFromPreviousUpload(d[0]),i.start()}),i},Y=()=>{const e=new Uint32Array(10);crypto.getRandomValues(e);const o=performance.now().toString(36),t=Array.from(e).map(s=>s.toString(36)).join("");return`${o}-${t}`};var n=D("../../packages/videopress/src/client/state/constants.js");const H=e=>{const{media_details:o,id:t,jetpack_videopress:s,jetpack_videopress_guid:r}=e,{videopress:i,width:d,height:c}=o,{title:p,description:_,caption:m,rating:S,allow_download:E,display_embed:I,privacy_setting:y,needs_playback_token:V,is_private:h}=s,{original:f,poster:$,upload_date:z,duration:J,file_url_base:Z,finished:q,files:ee={dvd:{original_img:""}}}=i||{},{dvd:F}=ee,oe=F!=null&&F.original_img?`${Z.https}${F.original_img}`:void 0,te=f==null?void 0:f.split("/").slice(-1)[0];return{id:t,guid:r,title:p,description:_,caption:m,url:f,uploadDate:z,duration:J,isPrivate:h,posterImage:$,allowDownload:E,displayEmbed:I,rating:S,privacySetting:y,needsPlaybackToken:V,width:d,height:c,poster:{src:$},thumbnail:oe,finished:q,filename:te}},ge=e=>{var o;return(o=e==null?void 0:e.map)==null?void 0:o.call(e,H)},me=e=>{const{media_details:o,id:t,jetpack_videopress:s,source_url:r,date:i}=e,{width:d,height:c,length:p}=o,{title:_,description:m,caption:S}=s;return{id:t,title:_,description:m,caption:S,width:d,height:c,url:r,uploadDate:i,duration:p}},Ee=e=>e.map(me),Ie=(e,o)=>n.zG[e]===n.az?!1:n.zG[e]===n.o0?!0:o,Ve=M.__,j=x()("videopress:actions"),G=async e=>{const o=await(0,v.A)({path:(0,R.F)(`${n.$s}/${e==null?void 0:e.id}`)}),t=H(o);return(t==null?void 0:t.posterImage)!==null&&(t==null?void 0:t.posterImage)!==""?Promise.resolve(t):new Promise((s,r)=>{setTimeout(()=>{G(e).then(s).catch(r)},2e3)})},Do={setIsFetchingVideos:e=>({type:n.QK,isFetching:e}),setFetchVideosError:e=>({type:n.Ms,error:e}),setVideosQuery:e=>({type:n.pz,query:e}),setVideosPagination:e=>({type:n.Ni,pagination:e}),setVideosFilter:(e,o,t)=>({type:n.B1,filter:e,value:o,isActive:t}),setVideos:e=>({type:n.c$,videos:e}),dismissFirstVideoPopover:()=>({type:n.IX}),setLocalVideos:e=>({type:n.UB,videos:e}),setIsFetchingLocalVideos:e=>({type:n.k8,isFetching:e}),setLocalVideosQuery:e=>({type:n.DE,query:e}),setLocalVideosPagination:e=>({type:n.DX,pagination:e}),setVideosStorageUsed:e=>({type:n.qd,used:e}),setVideo:(e,o=!1)=>({type:n.Rd,video:e,addAtEnd:o}),setIsFetchingUploadedVideoCount:e=>({type:n.u7,isFetchingUploadedVideoCount:e}),setUploadedVideoCount:e=>({type:n.E9,uploadedVideoCount:e}),setVideoPrivacy:({id:e,privacySetting:o})=>({type:n.wx,id:e,privacySetting:o}),updateVideoPrivacy:(e,o)=>async({dispatch:t,select:s,resolveSelect:r})=>{const i=Number(o);if(isNaN(i))throw new Error(`Invalid privacy level: '${o}'`);if(0>i||i>=n.zG.length)throw new Error(`Invalid privacy level: '${o}'`);if(o===1){const d=await s.getVideo(e);await r.getPlaybackToken(d==null?void 0:d.guid)}t.setVideoPrivacy({id:e,privacySetting:i});try{const d=await(0,v.A)({path:n.bT,method:"POST",data:{id:e,privacy_setting:i}});if((d==null?void 0:d.data)!==200)return;const{videoPressVideosPrivateForSite:c}=s.getVideoPressSettings();return t.updateVideoIsPrivate(e,Ie(i,c)),t({type:n.d$,id:e,privacySetting:i})}catch(d){console.error(d)}},removeVideo:e=>({type:n.H9,id:e}),deleteVideo:e=>async({dispatch:o,select:t})=>{o.removeVideo(e);let s={type:n.WX,id:e,hasBeenDeleted:!1,video:{}};try{const i=await(0,v.A)({path:`${n.$s}/${e}`,method:"DELETE",data:{id:e,force:!0}});i!=null&&i.deleted&&(s={...s,hasBeenDeleted:!0,video:i==null?void 0:i.previous})}catch(i){console.error(i)}finally{o(s)}t.getProcessedAllVideosBeingRemoved()&&(o({type:n.Aq}),o({type:n.kb}))},uploadVideo:e=>async({dispatch:o})=>{const t=Y();j("Uploading video"),o({type:n.NX,id:t,title:e==null?void 0:e.name});const s=await X("upload-jwt");_e({tokenData:s,file:e,onError:c=>{var _;j("Upload error",c);const p=((_=c==null?void 0:c.originalResponse)==null?void 0:_.getHeader("x-videopress-upload-error"))||Ve("Upload error","jetpack-videopress-pkg");o({type:n.SH,id:t,error:p})},onProgress:(c,p)=>{o({type:n.TZ,id:t,bytesSent:c,bytesTotal:p})},onSuccess:async c=>{j("Video uploaded",c),o({type:n.TI,id:t,data:c});const p=await G(c);o({type:n.Ko,video:p})}})},uploadVideoFromLibrary:e=>async({dispatch:o})=>{const t=Y();o({type:n.NX,id:t,title:e==null?void 0:e.title});const s=await K(e==null?void 0:e.id);o({type:n.K,id:e==null?void 0:e.id}),o({type:n.TI,id:t,data:s});const r=await G(s);o({type:n.Ko,video:r})},setIsFetchingPurchases:e=>({type:n.en,isFetching:e}),setPurchases:e=>({type:n.GY,purchases:e}),updateVideoPoster:(e,o,t)=>async({dispatch:s,select:r,resolveSelect:i})=>{var S,E;const d=`${n.v2}/${o}/poster`,c=await r.getVideo(e),p=async()=>{if(!c.needsPlaybackToken)return null;const I=await i.getPlaybackToken(c.guid);return I==null?void 0:I.token},_=(I,y)=>!I||!y?I:`${I}?metadata_token=${y}`,m=()=>{setTimeout(async()=>{var I,y;try{const V=await(0,v.A)({path:d,method:"GET"});if((I=V==null?void 0:V.data)!=null&&I.generating)m();else{const h=await p(),f=(y=V==null?void 0:V.data)==null?void 0:y.poster;s({type:n.OU,id:e,poster:_(f,h)}),(0,v.A)({path:n.bT,method:"POST",data:{id:e,poster:f}})}}catch(V){console.error(V)}},2e3)};try{s({type:n.N1,id:e});const I=c.duration-t.at_time;I<50&&(t.at_time-=I+50);const y=await(0,v.A)({method:"POST",path:d,data:t});if((S=y==null?void 0:y.data)!=null&&S.generating){m();return}const V=await p(),h=_((E=y==null?void 0:y.data)==null?void 0:E.poster,V);return s({type:n.OU,id:e,poster:h})}catch(I){console.error(I)}},setUsers:e=>({type:n.q2,users:e}),setUsersPagination:e=>({type:n.NS,pagination:e}),setIsFetchingPlaybackToken:e=>({type:n.$N,isFetching:e}),setPlaybackToken:e=>({type:n.h7,playbackToken:e}),expirePlaybackToken:e=>({type:n.kp,guid:e}),setVideoPressSettings:e=>({type:n.Cj,videoPressSettings:e}),updateVideoPressSettings:e=>async({dispatch:o})=>{if(!e)return;const t={force:!0};typeof e.videoPressVideosPrivateForSite=="boolean"&&(t.videopress_videos_private_for_site=e.videoPressVideosPrivateForSite);try{return o.setVideoPressSettings(e),await(0,v.A)({path:n.pC,method:"PUT",data:t})}catch(s){console.error(s)}},updateVideoIsPrivate:(e,o)=>({type:n.LF,id:e,isPrivate:o}),dismissErroredVideo:e=>({type:n.RZ,id:e})};var Eo=D("../../../node_modules/.pnpm/@wordpress+data@10.9.0_react@18.3.1/node_modules/@wordpress/data/build-module/index.js"),Me=D("../../../node_modules/.pnpm/@wordpress+url@4.9.0/node_modules/@wordpress/url/build-module/clean-for-slug.js");function ye(){return{order:"desc",orderBy:"date",itemsPerPage:6,page:1,type:"video/videopress"}}const Io=(e,o)=>{var t,s,r,i,d,c,p,_,m,S,E,I,y,V,h,f,$,z,J,Z,q,ee,F,oe,te,Ye,Qe,ze,Je,Ze,qe,eo,oo,to;switch(o.type){case n.QK:return{...e,isFetching:o.isFetching};case n.Ms:{const{error:l}=o;return{...e,isFetching:!1,error:l}}case n.pz:return{...e,query:{...e.query,...o.query},_meta:{...e._meta,relyOnInitialState:!1}};case n.Ni:return{...e,pagination:{...e.pagination,...o.pagination},_meta:{...e._meta,relyOnInitialState:!1}};case n.B1:{const{filter:l,value:u,isActive:a}=o;return{...e,filter:{...e.filter,[l]:{...((t=e.filter)==null?void 0:t[l])||{},[u]:a}},_meta:{...e._meta,relyOnInitialState:!1}}}case n.c$:{const{videos:l}=o;return{...e,items:l,isFetching:!1}}case n.Rd:{const{video:l,addAtEnd:u=!1}=o,a=[...(s=e.items)!=null?s:[]],g=a.findIndex(T=>T.id===l.id);return g===-1?u?a.push(l):a.unshift(l):a[g]={...a[g],...l},{...e,isFetching:!1,items:a}}case n.wx:{const{id:l,privacySetting:u}=o,a=[...(r=e.items)!=null?r:[]],g=a.findIndex(A=>A.id===l);if(g<0)return e;const T=a[g].privacySetting;a[g]={...a[g],privacySetting:u};const P={...(d=(i=e._meta)==null?void 0:i.items)!=null?d:[]},O=(c=P[l])!=null?c:{};return{...e,items:a,_meta:{...e._meta,items:{...P,[l]:{...O,isUpdatingPrivacy:!0,hasBeenUpdatedPrivacy:!1,prevPrivacySetting:T}}}}}case n.d$:{const{id:l}=o,u={...(_=(p=e._meta)==null?void 0:p.items)!=null?_:[]};if(!(u!=null&&u[l]))return e;const a=(m=u[l])!=null?m:{};return{...e,_meta:{...e._meta,items:{...u,[l]:{...a,isUpdatingPrivacy:!1,hasBeenUpdatedPrivacy:!0,prevPrivacySetting:null}}}}}case n.LF:{const{id:l,isPrivate:u}=o,a=[...(S=e.items)!=null?S:[]],g=a.findIndex(T=>T.id===l);return g<0?e:(a[g]={...a[g],isPrivate:u},{...e,items:a})}case n.H9:{const{id:l}=o,{items:u=[]}=e;if(u.findIndex(P=>P.id===l)<0)return e;const g={...(I=(E=e._meta)==null?void 0:E.items)!=null?I:[]},T=(y=g[l])!=null?y:{};return{...e,_meta:{...e._meta,videosBeingRemoved:[{id:l,processed:!1,deleted:!1},...(V=e._meta.videosBeingRemoved)!=null?V:[]],items:{...g,[l]:{...T,isDeleting:!0}}}}}case n.WX:{const{id:l,hasBeenDeleted:u,video:a}=o,g=((h=e==null?void 0:e._meta)==null?void 0:h.items)||[],T=g[l]||{},P=[...(f=e._meta.videosBeingRemoved)!=null?f:[]],O=P.findIndex(k=>k.id===l);if(!T||O<0)return e;P[O].processed=!0,P[O].deleted=u;const A=P.filter(k=>!k.processed).length===0;let b=($=e.uploadedVideoCount)!=null?$:0;if(A){const k=P.filter(C=>C.deleted).length;b=b-k}return{...e,uploadedVideoCount:b,_meta:{...e._meta,videosBeingRemoved:P,processedAllVideosBeingRemoved:A,items:{...g,[l]:{...T,hasBeenDeleted:u,deletedVideo:a}}}}}case n.kb:return{...e,_meta:{...e._meta,videosBeingRemoved:[],relyOnInitialState:!1}};case n.Aq:{const{items:l=[],query:u={},pagination:a={},_meta:g={}}=e,{videosBeingRemoved:T=[]}=g,P=T.filter(se=>se.deleted).length,O=(l==null?void 0:l.length)===P,A=(z=u==null?void 0:u.page)!=null?z:1,b=(J=a==null?void 0:a.totalPages)!=null?J:1,k=a==null?void 0:a.total,C=O&&A>1?A-1:A,ne=O&&b>1?b-1:b;return{...e,query:{...u,page:C},pagination:{...a,total:k-1,totalPages:ne}}}case n.qd:return{...e,storageUsed:o.used};case n.u7:return{...e,isFetchingUploadedVideoCount:o.isFetchingUploadedVideoCount};case n.E9:return{...e,uploadedVideoCount:o.uploadedVideoCount,isFetchingUploadedVideoCount:!1};case n.NX:{const{id:l,title:u}=o,a=(e==null?void 0:e._meta)||{},g=(a==null?void 0:a.items)||{},T=(0,Me.O)(u);return{...e,_meta:{...a,items:{...g,[l]:{title:T,uploading:!0}}}}}case n.SH:{const{id:l,error:u}=o,a=(e==null?void 0:e._meta)||{},g=(a==null?void 0:a.items)||{};return{...e,_meta:{...a,items:{...g,[l]:{...g[l],uploading:!1,error:u}}}}}case n.RZ:{const{id:l}=o,u=(e==null?void 0:e._meta)||{},a=(u==null?void 0:u.items)||{};return delete a[l],{...e,_meta:{...u,items:{...a}}}}case n.TI:{const{id:l,data:u}=o,a=(Z=e==null?void 0:e.query)!=null?Z:ye(),g={...e.pagination},T=[...(q=e==null?void 0:e.items)!=null?q:[]],P=(e==null?void 0:e._meta)||{},O=Object.assign({},(P==null?void 0:P.items)||{}),A=((oe=(F=(ee=u==null?void 0:u.src)==null?void 0:ee.split("/"))==null?void 0:F.slice(-1))==null?void 0:oe[0])||((te=O[l])==null?void 0:te.title)||"",b=(0,Me.O)(A);let k=(Ye=e==null?void 0:e.uploadedVideoCount)!=null?Ye:0,C=(Qe=e==null?void 0:e.firstUploadedVideoId)!=null?Qe:null,ne=(ze=e==null?void 0:e.firstVideoProcessed)!=null?ze:!1,se=(Je=e==null?void 0:e.dismissedFirstVideoPopover)!=null?Je:!1;return k===0&&(C=u.id,ne=!1,se=!1),(a==null?void 0:a.page)===1&&!(a!=null&&a.search)&&(k=((Ze=e==null?void 0:e.uploadedVideoCount)!=null?Ze:0)+1,g.total=k,g.totalPages=Math.ceil(k/(a==null?void 0:a.itemsPerPage)),T.unshift({id:u.id,guid:u.guid,url:u.src,title:b,posterImage:null,finished:!1})),delete O[l],{...e,items:T,uploadedVideoCount:k,firstUploadedVideoId:C,firstVideoProcessed:ne,dismissedFirstVideoPopover:se,pagination:g,_meta:{...P,items:O}}}case n.Ko:{const{video:l}=o,u=[...(qe=e==null?void 0:e.items)!=null?qe:[]],a=u.findIndex(P=>P.id===l.id),g=(eo=e==null?void 0:e.firstUploadedVideoId)!=null?eo:null;let T=(oo=e==null?void 0:e.firstVideoProcessed)!=null?oo:null;return l.id===g&&(T=!0),a===-1?{...e,firstVideoProcessed:T}:(u[a]=l,{...e,firstVideoProcessed:T,items:u})}case n.N1:{const{id:l}=o,u=(e==null?void 0:e._meta)||{},a=(u==null?void 0:u.items)||{},g=a[l]||{};return{...e,_meta:{...u,items:{...a,[l]:{...g,isUpdatingPoster:!0}}}}}case n.OU:{const{id:l,poster:u}=o,a=[...(to=e.items)!=null?to:[]],g=(e==null?void 0:e._meta)||{},T=(g==null?void 0:g.items)||{},P=a.findIndex(O=>O.id===l);return P>=0&&(a[P]={...a[P],posterImage:u}),{...e,items:a,_meta:{...g,items:{...T,[l]:{isUpdatingPoster:!1}}}}}case n.TZ:{const{id:l,bytesSent:u,bytesTotal:a}=o,g=(e==null?void 0:e._meta)||{},T=(g==null?void 0:g.items)||{},P=T[l]||{},O=a>0?u/a:0;return{...e,_meta:{...g,items:{...T,[l]:{...P,uploadProgress:O}}}}}case n.IX:return{...e,dismissedFirstVideoPopover:!0,firstUploadedVideoId:null};default:return e}},Vo=(e,o)=>{var t;switch(o.type){case n.UB:{const{videos:s}=o;return{...e,items:s,isFetching:!1}}case n.k8:return{...e,isFetching:o.isFetching};case n.DE:return{...e,query:{...e.query,...o.query},_meta:{...e._meta,relyOnInitialState:!1}};case n.DX:return{...e,pagination:{...e.pagination,...o.pagination},_meta:{...e._meta,relyOnInitialState:!1}};case n.K:{const{id:s}=o,r=[...(t=e==null?void 0:e.items)!=null?t:[]],i=r.findIndex(d=>d.id===s);return i===-1?e:(r[i]={...r[i],isUploadedToVideoPress:!0},{...e,items:r,isFetching:!1})}}return e},To=(e,o)=>{switch(o.type){case n.q2:return{...e,items:o.users};case n.NS:return{...e,pagination:{...(e==null?void 0:e.pagination)||{},...o.pagination}};default:return e}},Po=(e,o)=>{switch(o.type){case n.en:return{...e,isFetching:o.isFetching};case n.GY:return{...e,items:o.purchases,isFetching:!1};default:return e}},So=(e,o)=>{var t,s;switch(o.type){case n.$N:return{...e,isFetching:o.isFetching};case n.h7:{const{playbackToken:r}=o,i=[...(t=e.items)!=null?t:[]],d=i.findIndex(c=>c.guid===r.guid);return d===-1?i.unshift(r):i[d]={...i[d],...r},{...e,items:i,isFetching:!1}}case n.kp:{const{guid:r}=o,i=[...(s=e.items)!=null?s:[]],d=i.findIndex(c=>c.guid===r);return d>-1&&i.splice(d,1),{...e,items:i,isFetching:!1}}default:return e}},yo=(e,o)=>{switch(o.type){case n.Cj:{const{videoPressSettings:t}=o;return{...e,...t}}default:return e}},Ao=(0,Eo.HY)({videos:Io,localVideos:Vo,purchases:Po,users:To,playbackTokens:So,siteSettings:yo}),Ro=null,{apiRoot:Q}=(window==null?void 0:window.jetpackVideoPressInitialState)||{};async function Be(e,o,t){if(!e.needsPlaybackToken)return e;let s=await o.getPlaybackToken(e.guid);return s&&Number(s.issueTime)+864e5<Date.now()&&(await t.expirePlaybackToken(e.guid),s=await o.getPlaybackToken(e.guid)),/metadata_token=/.test(e.posterImage)||(e.posterImage+=`?metadata_token=${s.token}`),/metadata_token=/.test(e.thumbnail)||(e.thumbnail+=`?metadata_token=${s.token}`),/metadata_token=/.test(e.url)||(e.url+=`?metadata_token=${s.token}`),e}const Ho={getStorageUsed:{isFulfilled:e=>{var o,t;return(t=(o=e==null?void 0:e.videos)==null?void 0:o._meta)==null?void 0:t.relyOnInitialState},fulfill:()=>async({dispatch:e})=>{var o;try{const t=await(0,v.A)({path:n.Dv});if(!((o=t==null?void 0:t.options)!=null&&o.videopress_storage_used))return;const s=t.options.videopress_storage_used?Math.round(Number(t.options.videopress_storage_used)*1e3*1e3):0;e.setVideosStorageUsed(s)}catch(t){console.error(t)}}},getUploadedVideoCount:{isFulfilled:e=>{var o,t;return(t=(o=e==null?void 0:e.videos)==null?void 0:o._meta)==null?void 0:t.relyOnInitialState},fulfill:()=>async({dispatch:e})=>{const o={per_page:1,media_type:"video",mime_type:"video/videopress"};e.setIsFetchingUploadedVideoCount(!0);try{const t=await fetch((0,R.F)(`${Q}${n.$s}`,o)),s=Number(t.headers.get("X-WP-Total"));return e.setUploadedVideoCount(s),s}catch(t){console.error(t)}},shouldInvalidate:e=>e.type===n.TI||e.type===n.kb},getVideos:{isFulfilled:e=>{var o,t;return(t=(o=e==null?void 0:e.videos)==null?void 0:o._meta)==null?void 0:t.relyOnInitialState},fulfill:()=>async({dispatch:e,select:o,resolveSelect:t})=>{e.setIsFetchingVideos(!0);let s=o.getVideosQuery();s||(s=ye(),e.setVideosQuery(s));const r={order:s.order,orderby:s.orderBy,page:s.page,per_page:s.itemsPerPage,media_type:"video",mime_type:"video/videopress"};typeof s.search=="string"&&s.search.length>0&&(r.search=s.search);const i=o.getVideosFilter(),d=Object.keys((i==null?void 0:i.rating)||{}).filter(_=>i.rating[_]).join(",");d!=null&&d.length&&(r.videopress_rating=d);const c=Object.keys((i==null?void 0:i.privacy)||{}).filter(_=>i.privacy[_]).join(",");c!=null&&c.length&&(r.videopress_privacy_setting=c);const p=Object.keys((i==null?void 0:i.uploader)||{}).filter(_=>i.uploader[_]).join(",");p!=null&&p.length&&(r.author=p);try{const _=await fetch((0,R.F)(`${Q}${n.$s}`,r)),m=Number(_.headers.get("X-WP-Total")),S=Number(_.headers.get("X-WP-TotalPages"));e.setVideosPagination({total:m,totalPages:S});const E=await _.json(),I=await Promise.all(ge(E).map(async y=>await Be(y,t,e)));return e.setVideos(I),E}catch(_){console.error(_)}},shouldInvalidate:({type:e})=>e===n.pz||e===n.kb||e===n.B1},getVideo:{isFulfilled:(e,o)=>{var r,i;if(!o||typeof o=="string")return!0;const s=((r=e.videos.items)!=null?r:[]).find(({id:d})=>d===o);return s&&s.needsPlaybackToken?!!(((i=e==null?void 0:e.playbackTokens)==null?void 0:i.items)||[]).find(p=>(p==null?void 0:p.guid)===s.guid):s},fulfill:(e,o=!1)=>async({dispatch:t,resolveSelect:s})=>{t.setIsFetchingVideos(!0);try{const r=await(0,v.A)({path:(0,R.F)(`${n.$s}/${e}`)}),i=await Be(H(r),s,t);return t.setVideo(i,o),r}catch(r){console.error(r)}}},getLocalVideos:{isFulfilled:e=>{var o,t;return(t=(o=e==null?void 0:e.localVideos)==null?void 0:o._meta)==null?void 0:t.relyOnInitialState},fulfill:()=>async({dispatch:e,select:o})=>{let t=o.getLocalVideosQuery();e.setIsFetchingLocalVideos(!0),t||(t=ye(),e.setVideosQuery(t));const s={order:t.order,orderby:t.orderBy,page:t.page,per_page:t.itemsPerPage,media_type:"video",no_videopress:!0};typeof t.search=="string"&&t.search.length>0&&(s.search=t.search);try{const r=await fetch((0,R.F)(`${Q}${n.$s}`,s)),i=Number(r.headers.get("X-WP-Total")),d=Number(r.headers.get("X-WP-TotalPages"));e.setLocalVideosPagination({total:i,totalPages:d});const c=await r.json();return e.setLocalVideos(Ee(c)),c}catch(r){console.error(r)}},shouldInvalidate:e=>e.type===n.DE},getUsers:{isFulfilled:e=>{var o,t;return(t=(o=e==null?void 0:e.users)==null?void 0:o._meta)==null?void 0:t.relyOnInitialState},fulfill:()=>async({dispatch:e})=>{e.setIsFetchingLocalVideos(!0);try{const o=await fetch(`${Q}${n.p9}`),t=Number(o.headers.get("X-WP-Total")),s=Number(o.headers.get("X-WP-TotalPages"));e.setUsersPagination({total:t,totalPages:s});const r=await o.json();return r!=null&&r.length?(e.setUsers(r.map(i=>({id:i.id,name:i.name,slug:i.slug,description:i.description,link:i.link,avatar:i.avatar_urls}))),r):void 0}catch(o){console.error(o)}}},getPlaybackToken:{isFulfilled:(e,o)=>{var s,r;const t=(r=(s=e==null?void 0:e.playbackTokens)==null?void 0:s.items)!=null?r:[];return t==null?void 0:t.some(i=>(i==null?void 0:i.guid)===o)},fulfill:e=>async({dispatch:o})=>{o.setIsFetchingPlaybackToken(!0);try{const t=await(0,v.A)({path:(0,R.F)(`${n.TC}/${e}`),method:"POST"}),s={guid:e,token:t.playback_token,issueTime:Date.now()};return o.setPlaybackToken(s),s}catch(t){console.error(t)}},shouldInvalidate:(e,o)=>e.type===n.kp&&e.guid===o},getVideoPressSettings:{isFulfilled:e=>(e==null?void 0:e.siteSettings)!==void 0,fulfill:()=>async({dispatch:e})=>{try{const{videopress_videos_private_for_site:o}=await(0,v.A)({path:(0,R.F)(`${n.pC}`),method:"GET"}),t={videoPressVideosPrivateForSite:o};return e.setVideoPressSettings(t),t}catch(o){console.error(o)}}}},Ke=e=>{var o;return((o=e==null?void 0:e.videos)==null?void 0:o.items)||[]},_t={getVideos:Ke,getUploadingVideos:e=>{var t,s;const o=((s=(t=e==null?void 0:e.videos)==null?void 0:t._meta)==null?void 0:s.items)||{};return Object.keys(o||{}).map(r=>({...o[r],id:r})).filter(r=>r.uploading)},getVideosQuery:e=>{var o;return(o=e==null?void 0:e.videos)==null?void 0:o.query},getPagination:e=>{var o;return(o=e==null?void 0:e.videos)==null?void 0:o.pagination},getVideosFilter:e=>{var o;return(o=e==null?void 0:e.videos)==null?void 0:o.filter},getUploadedVideoCount:e=>{var o;return(o=e==null?void 0:e.videos)==null?void 0:o.uploadedVideoCount},getIsFetching:e=>{var o;return(o=e==null?void 0:e.videos)==null?void 0:o.isFetching},getIsFetchingUploadedVideoCount:e=>{var o;return(o=e==null?void 0:e.videos)==null?void 0:o.isFetchingUploadedVideoCount},getStorageUsed:e=>{var o;return{storageUsed:(o=e==null?void 0:e.videos)==null?void 0:o.storageUsed}},getFirstUploadedVideoId:e=>{var o;return(o=e==null?void 0:e.videos)==null?void 0:o.firstUploadedVideoId},getFirstVideoProcessed:e=>{var o;return(o=e==null?void 0:e.videos)==null?void 0:o.firstVideoProcessed},getDismissedFirstVideoPopover:e=>{var o;return(o=e==null?void 0:e.videos)==null?void 0:o.dismissedFirstVideoPopover},getProcessedAllVideosBeingRemoved:e=>{var o,t;return(t=(o=e==null?void 0:e.videos)==null?void 0:o._meta)==null?void 0:t.processedAllVideosBeingRemoved},getLocalVideos:e=>{var o;return((o=e==null?void 0:e.localVideos)==null?void 0:o.items)||[]},getIsFetchingLocalVideos:e=>{var o;return(o=e==null?void 0:e.localVideos)==null?void 0:o.isFetching},getLocalVideosQuery:e=>{var o;return(o=e==null?void 0:e.localVideos)==null?void 0:o.query},getLocalPagination:e=>{var o;return(o=e==null?void 0:e.localVideos)==null?void 0:o.pagination},getUploadedLocalVideoCount:e=>{var o;return(o=e==null?void 0:e.localVideos)==null?void 0:o.uploadedVideoCount},getVideo:(e,o)=>Ke(e).find(({id:r})=>r===o),getVideoStateMetadata:(e,o)=>{var r,i;return(((i=(r=e==null?void 0:e.videos)==null?void 0:r._meta)==null?void 0:i.items)||{})[o]||{}},getUsers:e=>{var o;return((o=e==null?void 0:e.users)==null?void 0:o.items)||[]},getUsersPagination:e=>{var o;return(o=e==null?void 0:e.users)==null?void 0:o.pagination},getPurchases:e=>{var o;return((o=e==null?void 0:e.purchases)==null?void 0:o.items)||[]},isFetchingPurchases:e=>{var o;return(o=e==null?void 0:e.purchases)==null?void 0:o.isFetching},getPlaybackToken:(e,o)=>{var r;return(((r=e==null?void 0:e.playbackTokens)==null?void 0:r.items)||[]).find(i=>(i==null?void 0:i.guid)===o)||{}},isFetchingPlaybackToken:e=>{var o;return(o=e==null?void 0:e.playbackTokens)==null?void 0:o.isFetching},getVideoPressSettings:e=>e==null?void 0:e.siteSettings,getUploadErrorVideos:e=>{var t,s;const o=((s=(t=e==null?void 0:e.videos)==null?void 0:t._meta)==null?void 0:s.items)||{};return Object.keys(o||{}).map(r=>({...o[r],id:r})).filter(r=>!!r.error)}},gt=null,fo=x()("videopress/media:state"),Xe=((We=window.jetpackVideoPressInitialState)==null?void 0:We.initialState)||{videos:{}},U=window.location.hash.split("?");(U==null?void 0:U[0])==="#/"&&(U!=null&&U[1])&&(U==null?void 0:U[1])!=="page=1"&&(Xe.videos.isFetching=!0);function mt(){fo("Initializing %o store",STORE_ID),storeHolder.mayBeInit(STORE_ID,{__experimentalUseThunks:!0,reducer,actions,selectors,resolvers,initialState:Xe})}}}]);})();
